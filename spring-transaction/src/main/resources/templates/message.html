<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>메시지 관리</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="/js/common.js"></script> <!-- ajaxPost 함수 정의되어 있어야 함 -->
</head>
<body>

<style>
	/* readonly input 스타일 */
	input[readonly] {
	    background-color: #f2f2f2;
	    color: #666;
	    cursor: not-allowed;
	}
	
	/* readonly인데 focus 갔을 때도 동일하게 */
	input[readonly]:focus {
	    outline: none;
	    box-shadow: none;
	}
</style>

<h2>메시지 관리</h2>

<h3>메시지 조회</h3>
<label>메시지 코드: <input type="text" id="searchMessageCode"></label>
<label>메시지 내용: <input type="text" id="searchMessageText"></label>
<label>사용여부: 
    <select id="searchUseYn">
        <option value="">전체</option>
        <option value="Y">사용</option>
        <option value="N">미사용</option>
    </select>
</label>
<button type="button" id="btnMessageSearch">조회</button>

<div id="messageResult"></div>

<h3>메시지 상세</h3>
<form id="messageForm">
	
	<!-- 상태값 신규/수정 -->
	<input type="hidden" id="status" name="status" value="C">
	
	<label>메시지 코드: <input type="text" id="messageCode" name="messageCode" required></label><button type="button" id="btnMessaCodeCheck">중복확인</button><br><br>
	<label>메시지 내용: <input type="text" id="messageText" name="messageText" required></label><br><br>
	<label>메시지 설명: <input type="text" id="messageDes"  name="messageDes" required></label><br><br>
	<label>사용 여부: 
	    <select id="useYn" name="useYn" required>
	      <option value="Y" selected>사용</option>
	      <option value="N">미사용</option>
	    </select>
	</label>
	<button type="button" id="btnMessageSave">메시지 저장</button>
</form>

<div id="messageSaveResult"></div>

<button id="btnCreateMessages">신규</button>
<button id="btnDeleteMessages">삭제</button>

<script>
	$(document).ready(function() {
		
		// 조회
		$("#btnMessageSearch").on("click", btnMessageSearch);
		
		// 저장
		$("#btnMessageSave").on("click", btnMessageSave);
		
		// 삭제
		$("#btnDeleteMessages").on("click", btnMessagesDelete);
		
		// 신규
		$("#btnCreateMessages").on("click", btnCreateMessages);
		
		// 코드 중복 체크
		$("#btnMessageCodeDupCheck").on("click", btnMessageCodeDupCheck);
		
		// 행클릭
		$("#messageResult").on("click", ".messageRow", messageRowClick);
		
		
	});
	
// 	function btnMessageSearch() {
// 	    const searchParams = {
// 	        messageCode: $("#searchMessageCode").val(),
// 	        messageText: $("#searchMessageText").val(),
// 	        useYn : $("#searchUseYn").val()
// 	    };

// 	    ajaxGet("/message/findMessageList", searchParams, function(response) {
// 	        if (response.code !== "SUCCESS") {
// 	            alert("에러확인필요");
// 	            return;
// 	        }

// 	        const messages = response.data;
// 	        alert(response.message);

// 	        let html = "";
// 	        html += "<h3>메시지 목록</h3>";
// 	        html += "<table border='1' style='width:100%; border-collapse:collapse;'>";
// 	        html += "<thead>";
// 	        html += "  <tr>";
// 	        html += "    <th>선택</th>";
// 	        html += "    <th>메세지코드</th>";
// 	        html += "    <th>메세지명</th>";
// 	        html += "    <th>메시지설명</th>";
// 	        html += "    <th>사용여부</th>";
// 	        html += "  </tr>";
// 	        html += "</thead>";
// 	        html += "<tbody>";

	        
// 	        // html data를 카밀케이스로 사용하기 위해서는 - 사용해야함
// 	        messages.forEach(function(messagesData) {
// 	            html += `
// 	                <tr class="messageRow" 
// 	                    data-message-code="${messagesData.messageCode}" 
// 	                    data-message-text="${messagesData.messageText}" 
// 	                    data-message-des="${messagesData.messageDes}" 
// 	                    data-use-yn="${messagesData.useYn}">
// 	                    <td style="text-align:center;">
// 	                        <input type="checkbox" name="selectedMessages" value="${messagesData.messageCode}">
// 	                    </td>
// 	                    <td>${messagesData.messageCode}</td>
// 	                    <td>${messagesData.messageText || ""}</td>
// 	                    <td>${messagesData.messageDes || ""}</td>
// 	                    <td>${messagesData.useYn === "Y" ? "사용" : "미사용"}</td>
// 	                </tr>
// 	            `;
// 	        });

// 	        html += "</tbody>";
// 	        html += "</table>";

// 	        $("#messageResult").html(html);
// 	    });
// 	}
	
	// 조회 버튼 함수
	function btnMessageSearch() {
	    const searchParams = {
	        messageCode: $("#searchMessageCode").val(),
	        messageText: $("#searchMessageText").val(),
	        useYn: $("#searchUseYn").val()
	    };

	    ajaxRequest("/message/findMessageList", { method:"GET", data:searchParams })
	        .then(response => {
	        	
	        	const messages = response.data;
	        	
	        	let html = "";
	        	html += "<h3>메시지 목록</h3>";
	        	html += "<table border='1' style='width:100%; border-collapse:collapse;'>";
	        	html += "<thead>";
	        	html += "  <tr>";
	        	html += "    <th>선택</th>";
	        	html += "    <th>메세지코드</th>";
	        	html += "    <th>메세지명</th>";
	        	html += "    <th>메시지설명</th>";
	        	html += "    <th>사용여부</th>";
	        	html += "  </tr>";
	        	html += "</thead>";
	        	html += "<tbody>";


	        	// html data를 카밀케이스로 사용하기 위해서는 - 사용해야함
	        	messages.forEach(function(messagesData) {
	        	 html += `
	        	      <tr class="messageRow" 
	        	          data-message-code="${messagesData.messageCode}" 
	        	          data-message-text="${messagesData.messageText}" 
	        	          data-message-des="${messagesData.messageDes}" 
	        	          data-use-yn="${messagesData.useYn}">
	        	          <td style="text-align:center;">
	        	              <input type="checkbox" name="selectedMessages" value="${messagesData.messageCode}">
	        	          </td>
	        	          <td>${messagesData.messageCode}</td>
	        	          <td>${messagesData.messageText || ""}</td>
	        	          <td>${messagesData.messageDes || ""}</td>
	        	          <td>${messagesData.useYn === "Y" ? "사용" : "미사용"}</td>
	        	      </tr>
	        	 `;
	        	});

	        	html += "</tbody>";
	        	html += "</table>";

	        	$("#messageResult").html(html);
	        	
	        	alert(response.message);
	        	
	        })
	        .catch(err => {
	            console.error(err);
	        });
	}
	
	// 메시지 코드 중복 체크 -> 요청데이터 일관성있게 변경하기
	function btnMessageCodeDupCheck() {
		const messageCode = $("#messageCode").val().trim();

		ajaxRequest("/message/findMessageCodeDupCheck", { method:"GET", data: {messageCode})
			.then(response => {
		    		
			})
		    .catch(err => {
		    	
		    });
	}
	
	function btnMessageSave() {
	  const messageData = {
	    messageCode : $("#messageCode").val(),
	    messageText : $("#messageText").val(),
	    messageDes  : $("#messageDes").val(),
	    status : $("#status").val(),
	    useYn : $("#useYn").val()
	  };

// 	  if (!messageData.messageCode || !messageData.messageText) {
// 	    alert("메시지 코드와 내용을 모두 입력하세요.");
// 	    return;
// 	  }

	  ajaxPost("/message/saveMessage", messageData, function(response) {
		  alert(response.message);
		  $("#messageForm")[0].reset(); //폼리셋
		  btnMessageSearch(); //별도의 페이지 이동 or 금융권 그리드 저장후 재조회 하도록 ? 상황에 맞게
		});
	}
	

	function btnMessagesDelete() {
		
		const checkedBoxes = $("input[name='selectedMessages']:checked");
		const selectedValues = checkedBoxes.map(function() {
			return this.value;
		}).get();
		
		if (selectedValues.length === 0) {
		    alert("삭제할 메시지를 선택하세요.");
		    return;
		}

		// messageCode 프로퍼티를 가진 객체 배열로 변환
		const requestData = selectedValues.map(code => ({ messageCode: code }));
		
		ajaxPost("/message/deleteMessages", requestData, function(response) {
			if (response.code === "SUCCESS") {
				alert("메시지가 성공적으로 삭제되었습니다.");
				btnMessageSearch();
			} else {
				alert("삭제 실패: " + response.message);
			}
		});
	};
	
	// 신규버튼 함수
	function btnCreateMessages() {
		
		$("#messageForm")[0].reset();
	    $("#status").val("C");
	    $("#messageCode").prop("readonly", false);
		
	}
	
	function messageRowClick() {
		
		const $messageRow = $(this);
		
		$("#messageForm")[0].reset();
		$("#status").val("U");
		$("#messageCode").prop("readonly", true);
		
	    const messageCode = $messageRow.data("messageCode");
	    const messageText = $messageRow.data("messageText");
	    const messageDes  = $messageRow.data("messageDes");
	    const useYn       = $messageRow.data("useYn");
	    
	    // 인풋필드 초기화함수 생성필요
	    $("#messageCode").val(messageCode); //readonly 처리
	    $("#messageText").val(messageText);
	    $("#messageDes").val(messageDes);
	    $("#useYn").val(useYn);
	    
	}
	





</script>
</body>
</html>
